<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><title>Product Selection</title>
<link  href="/dCSS/Theme2/default/common.css" type="text/css" media="handheld,print,projection,screen,tty,tv" rel="stylesheet" >
<link  href="/dCSS/Theme2/default/custom.css" type="text/css" media="handheld,print,projection,screen,tty,tv" rel="stylesheet" >
<link  href="/css/assistive.css" type="text/css" media="aural,braille,embossed" rel="stylesheet" >
<script src="http://www.salesforce.com/services/lib/ajax/beta3.3/sforceclient.js" type="text/javascript"></script>

<script type="text/javascript" src="/js/functions.js"></script>
<script type="text/javascript" src="/js/setup.js"></script>
<script type="text/javascript" src="/js/roletreenode.js"></script>
<link rel="shortcut icon" href="https://na1.salesforce.com/favicon.ico">
<script language="javascript"> 
var retUrl = "{!User.Link}";  // where we came from

function pageInit() {
	//contactHeader = document.getElementById("contactTable").firstChild.innerHTML;
	sforceClient.init("{!API.Session_ID}", "{!API.Partner_Server_URL_70}");
	if (sforceClient.getSessionId().indexOf("!API_Session_ID") != -1) {
		alert("Could not login using API"); 
		return; 
	} 
    
  	var uInfo = sforceClient.GetUserInfo(); // check for no API at this org
    if ( uInfo && uInfo.faultcode && uInfo.faultcode.indexOf("API_DISABLED_FOR_ORG")>0) {
    	alert( uInfo.faultstring +
		"\nThis custom link utilizes the AppExchange API.\n" +
		"It appears that the Salesforce.com edition you are using does not have this feature enabled."
         );
		return; 
    }
	
	setupForm();
}

var oppId = "{!Opportunity.Id}"; 
var opportunities = new Array(); // all my  opps
var qr;

function cancelUpdate() { window.parent.parent.location.href = retUrl; }
function trim(string) { return string.replace(/(^\xA0*)|(^\s*)|(\s*$)/g,''); } 
function SelectChecked(form, element_name, value) { 
	var i = 0; for (i = 0; i < form.elements.length; i++) { 
		if (form.elements[i].name == element_name) { 
			form.elements[i].checked = value; 
		} 
	} 
} 
function IsChecked(form, element_name, refresh) { 
	var strCloseDate = "";
	for (i = 0; i < form.elements.length; i++) { 
		if ( form.elements[i].name == 'opp9' ) { 
			strCloseDate = form.elements[i].value ; // grab the date to use
		} 
	}
	if ( strCloseDate == "" ) { 
		alert("Please enter a Close Date");  // bad user , please enter a date...
		return;
	}
	// check that the date entered is a valid date
	var jsCloseDate = Sforce.Util.ParseDate(strCloseDate);
	if ( jsCloseDate == null ) { 
		alert("Please enter a Valid Date");  // bad user , please enter a date...
		return;
	} 
	var updateObjects = new Array();
	for (i = 0; i < form.elements.length; i++) { 
		if ((form.elements[i].name == element_name) && (form.elements[i].checked)) { 
			var contact = opportunities[form.elements[i].value.replace(" ", "")];
			contact.set("CloseDate", jsCloseDate);
			updateObjects.push(contact);
		} 
	} 

	if (updateObjects.length > 0) { 
		var x = window.confirm("Are you sure you want to update "+ updateObjects.length +" record(s) ?"); 
		if (x) { 
			var sr = sforceClient.Update(updateObjects);
			// check the return array value here !!
			var failed = 0; for (i=0 ; i < sr.size; i++) { 
				if (sr[i].success == false) { failed++; } 
			}
			if ( failed > 0 ) { 
				alert( "Could not udpate one or more of the opportunities!");
			}
			if ( refresh == null ) { // go back
				window.parent.parent.location.href = retUrl; 
			} else { // just refresh
				window.parent.parent.location.href = window.parent.parent.location.href; 
			} 
		} 
	} else { 
		alert("No Records will be updated"); 
		window.parent.parent.location.href = retUrl; 
	} 
} 

//--> 
</script>
<script language="javascript"> 
<!-- 
function setupForm() {	//  Query to get Opp informaiont for this user

	// construct the table and header
	var div = document.getElementById('divTableHeader');
	var ta = createTag(div,"table",{'class':"list" ,'width':'100%','border':'0','cellspacing':'0','cellpadding':'0'} );
	var tb = createTag(ta,"tbody");
	var tr = createTag(tb,"tr",{'class':"headerRow"});
	
	createTag(createTag(tr,"th"), "input",{'type':'checkbox','onClick':"javascript:SelectChecked(document.forms['editPage'],'ids',this.checked)"})
	
	createTag(tr,"th",{'nowrap':'nowrap'}).innerHTML="Opportunity Name";
	var td = createTag(tr,"th",{'nowrap':'nowrap'}); 
	td.innerHTML="Close Date";
	createTag(td,"img",{'src':"/img/sort_desc_arrow.gif"})
	createTag(tr,"th",{'nowrap':'nowrap'}).innerHTML="Stage";
	
	var qr = sforceClient.Query( "Select Id, Name, CloseDate, StageName From Opportunity where IsClosed = False and OwnerId = '" +  "{!User.Id}" + "'" );
	if (qr.className != "QueryResult") {
		alert( qr.className + "could not udpate opportunities!" + qr.toString()); return;
	} 
	if (qr.size > 0) {
		
		qr.records.sort(sortDate); // nice to sort these records by "close date"  ascending
		
		for (var i=0;i<qr.records.length;i++) {
			var row;
			var atts = new Object();
			if (i==0) { // skin stuff
				atts["class"] = "dataRow even first";
			} else if (ta.even == true) {
				atts["class"] = "dataRow even";
			} else {
				atts["class"] = "dataRow odd";
			}
			ta.even = !ta.even;	
			atts["onmouseout"] =  "if (typeof(hiOff) != 'undefined'){hiOff(this);}";
			atts["onmouseover"] = "if (typeof(hiOn) != 'undefined'){hiOn(this);}";
			tr = createTag(tb,"tr",atts);
		 
			var opp = qr.records[i];
			var tabCol = [opp.get("Id"), 
				"<a href=\"/"+ opp.get("Id") + "\" target=\"_blank\" >" + opp.get("Name") + "</a>", 
				Sforce.Util.ToIsoDate(opp.get("CloseDate")), // could do a better job here of matching default format
				opp.get("StageName")];
			
			td = createTag(tr,"td")
			createTag(td,"input",{'type':'checkbox','name':'ids','id':'ids','value':tabCol[0]});
			
			for (var j=1;j<tabCol.length;j++) {
				createTag(tr,"td").innerHTML = "&nbsp;" + tabCol[j]; 
			} 
			opportunities[tabCol[0]] = opp; 
		}
	}						
}
function sortDate(a,b) {return a.get("CloseDate") - b.get("CloseDate");}

var sapp = new Sforce.Application(); // to get browser version
function createTag(parent, name, keyvalPairs) {
	var ret; 
	if (sapp.get_type() == Sforce.Application.Type.InternetExplorer) {
		var trTag = "<"+name+" ";
		for (key in keyvalPairs) {
				trTag += key + "=\"" + keyvalPairs[key] + "\"";
		}
		trTag += ">";
		ret = document.createElement(trTag);
	} else { 
		ret = document.createElement(name);
		for (key in keyvalPairs) {
			ret.setAttribute(key, keyvalPairs[key]);
		}
	} 
	parent.appendChild(ret);
	return ret;
}
function assert(fact,msg) { if ( fact ) { return true } 
	msg = "Assert failure \n" + msg
	if (arguments.callee.caller != null) { 
		msg = msg + " in function "+ arguments.callee.caller.toString().match(/function\s+(\w+)/)[1];
	} 
	alert(msg);
	return false
} 
//--> 
</script>
</head>
<body onload="pageInit()" class="opportunity overviewPage" >
<div class="bPageTitle">
<div class="ptBody secondaryPalette">
<div class="content">
<img src="/s.gif" alt="Account"  class="pageTitleIcon">
<h1 class="pageType">Open opportunties owned by {!User.Name}<span  class="titleSeparatingColon">:</span></h1>
<h2 class="pageDescription" id="desc">Update Close Dates</h2>
<div class="blank">&nbsp;</div></div>
<div class="links"></div>
</div><div class="ptBreadcrumb"></div></div>

<form name="editPage" id="editPage">
	
<b>Check one or more opportunities and enter a new close date</b>
<input name="opp9" id="opp9" size="12" tabindex="7" type="text">
<a href="javascript:openPopupFocus('/home/calendar.jsp?form=editPage&field=opp9&mo=0', '_blank', 193, 148, 'width=193,height=148,resizable=yes,toolbar=no,status=no,scrollbars=no,menubar=no,directories=no,location=no,dependant=yes', true, true);" tabindex="7" onclick="setLastMousePosition(event)"><img src="/img/date_picker.gif" alt="Pick A Date" title="Pick A Date" border="0" height="16" width="24"></a><span class="bodySmall"></span>

	<div class="blank">&nbsp;</div>
<div id="mainpageblock" class="bPageBlock secondaryPalette">
 
 <div id="outertable" class="pbHeader">
  <table class="outer" border="0" cellspacing="0" cellpadding="0" width="95%" >
  <tr>
	<td id="buttons" align="center">
		<input name="save1" value=" Update Now " class="button" type="button" 
			onclick="javascript: IsChecked(document.forms['editPage'],'ids','refresh')" >&nbsp;&nbsp;&nbsp;
		<input name="cancel" value=" Cancel " class="button" type="button" 
			onclick="javascript: cancelUpdate()" >
	
	</td> 
  </tr></table>
 </div>
 
 <div id="divTableHeader" class="pbBody"> <!-- the body --></div>

 <!--  --><div class="pbFooter secondaryPalette"> <div class="bg"></div></div> 

  </div> 
	
	</form>
</body>
</html>